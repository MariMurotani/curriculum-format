# 実装方法の執筆のサンプル例
ここには、実装方法を執筆する際どのように執筆していくかのサンプルを記載しています。参考になれば幸いです。

参考）[3-1 目次に沿って実装し、実装方法を執筆する](https://techpit-market.gitbook.io/host-guide/3-1)

<hr>


# 投稿機能の実装 ← 目次のタイトルを入れる
このパートでは投稿機能を開発していきます。

## 1

まず投稿機能で使うルーティングを追加します。

`config/routes.rb`に以下のコードを追加してください。


```diff
Rails.application.routes.draw do
  devise_for :users,
    controllers: { registrations: 'registrations' }

  root 'pages#home'

  get '/users/:id', to: 'users#show', as: 'user'

+  get '/posts/new', to: 'posts#new'
+  post '/posts', to: 'posts#create'
+  post '/posts/:post_id/photos', to: 'photos#create', as: 'post_photos'

end
```

## 2

追加したルーティングを確認します。

```
$ rails routes
```

下記のルーティングが今回設定したルーティングの情報になります。

```
posts_new   GET  /posts/new(.:format)             posts#new
posts       POST /posts(.:format)                 posts#create
post_photos POST /posts/:post_id/photos(.:format) photos#create
```

## 3

resourcesメソッドを使って、もっと簡単にルーティングを設定します。

`config/routes.rb`を以下のように編集してください。

```diff
Rails.application.routes.draw do
  devise_for :users,
    controllers: { registrations: 'registrations' }

  root 'pages#home'

  get '/users/:id', to: 'users#show', as: 'user'

-  get '/posts/new', to: 'posts#new'
-  post '/posts', to: 'posts#create'
-  post '/posts/:post_id/photos', to: 'photos#create', as: 'post_photos'
+  resources :posts, only: %i(new create) do
+    resources :photos, only: %i(create)
+  end

end
```


## 4
次に投稿ページで使うコントローラーを作成します。

以下のコマンドを実行してください。

```
$ rails g controller posts
```

上記のコマンドを実行するとターミナルに下記のような実行結果が表示されます。

```
Running via Spring preloader in process 76204
      create  app/controllers/posts_controller.rb
      invoke  erb
      create    app/views/posts
      invoke  test_unit
      create    test/controllers/posts_controller_test.rb
      invoke  helper
      create    app/helpers/posts_helper.rb
      invoke    test_unit
      invoke  assets
      invoke    coffee
      create      app/assets/javascripts/posts.coffee
      invoke    scss
      create      app/assets/stylesheets/posts.scss
```


## 5
次に作成したコントローラーにアクションを追加していきます。

`app/controllers/posts_controller.rb`に以下のコードを追加してください。

```diff
class PostsController < ApplicationController

+  def new
+    @post = Post.new
+    @post.photos.build
+  end

end
```

## 6

次にpostsコントローラーにcreateアクションを作成します。

`app/controllers/posts_controller.rb`に以下のコードを追加してください。

```diff
class PostsController < ApplicationController
  def new
    @post = Post.new
    @post.photos.build
  end

+  def create
+    @post = Post.new(post_params)
+    if @post.photos.present?
+      @post.save
+      redirect_to root_path
+      flash[:notice] = "投稿が保存されました"
+    else
+      redirect_to root_path
+      flash[:alert] = "投稿に失敗しました"
+    end
+  end
+
+  private
+    def post_params
+      params.require(:post).permit(:caption, photos_attributes: [:image]).merge(user_id: current_user.id)
+    end

end
```


## 7
`accepts_nested_attributes_for`メソッドを追加します。

`app/models/post.rb`に以下のコードを追加してください。

```diff
class Post < ApplicationRecord
  belongs_to :user
  has_many :photos, dependent: :destroy

+  accepts_nested_attributes_for :photos
end
```


## 8
最後にビューを追加します。app/views/posts/ディレクトリ内に`new.html.erb`を追加してください。

```
$ touch app/views/posts/new.html.erb
```

追加したら`new.html.erb`に以下のコードを追加してください。

```erb
<%= form_with model: @post do |f| %>
  <%= f.label :caption %>
  <%= f.text_field :caption %>
  <%= f.fields_for :photos do |i| %>
    <%= i.file_field :image %>
  <% end %>
  <%= f.submit "投稿", class: "btn btn-primary" %>
<% end %>
```


以上で今回のパートは終了です。

お疲れさまでした。

